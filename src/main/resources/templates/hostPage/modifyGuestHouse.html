<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="fragments/hostPage_layout">

   <head>
   		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>게스트하우스 수정</title>
      <style>
          .hostPage_label {
            padding: 18px 15px;
            font-size: 17px;
         }
         
         input, textarea {padding: 0 15px;}
         
         th, td {line-height: 20px;}
         
         th {width: 200px;}
         
         td {width: 500px; padding: 20px 0;}
         
         .imgs_wrap {
            width: 600px;
            margin-top: 20px;	
         }
         
         .imgs_wrap img {
            max-width: 170px;
            margin: 3px;	
         }
         
         /* The Modal (background) */
         .modal {
               display: none; /* Hidden by default */
               position: fixed; /* Stay in place */
               z-index: 1; /* Sit on top */
               left: 0;
               top: 0;
               width: 100%; /* Full width */
               height: 100%; /* Full height */
               overflow: auto; /* Enable scroll if needed */
               background-color: rgb(0,0,0); /* Fallback color */
               background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
           }
       
           /* Modal Content/Box */
           .modal-content {
               background-color: #fefefe;
               margin: 15% auto; /* 15% from the top a nd centered */
               padding: 20px;
               border: 1px solid #888;
               width: 50%; /* Could be more or less, depending on screen size */                          
           }
           /* The Close Button */
           .close {
               color: #aaa;
               float: right;
               font-size: 28px;
               font-weight: bold;
           }
           .close:hover,
           .close:focus {
               color: black;
               text-decoration: none;
               cursor: pointer;
           }
           .roomInfoDiv {
              display:  grid;
              background-color: #deebff;
              /* border: 1px solid gray; */
              margin: 10px 0;
           }
           
           input[type=file] {
           		display: initial;
           }
           
           .thumbnailImgSpan {
           		margin: 5px;
           }
           
           label>p {
           		font-size: 13px;
           }
           
           .checkboxLabel {
           		margin-right: 20px;
           }
           
           .room_imgs_wrap {
           		width: 400px;
           }
           
           .bank_label {
           		margin-right: 20px;
           }
           
           .room_tr {
           		padding: 0 0;
           }
      </style>
   </head>
   <body>
      <div layout:fragment="hostPage_content">
         <form id="modifyGuestHouseForm" th:action="@{modifyGuestHouseComplete}" method="POST" enctype="multipart/form-data">
            <h2>내 게스트하우스 수정하기</h2>
            <input type="hidden" name="guestHouseCode" th:value="${guestHouseCode}">
            <table class="guestHouse_table">
           		<tr>
           			<th><label class="hostPage_label">게스트하우스 사진<br>(최대 10장) <p>메인이미지를 선택해주세요.</p></label></th>
           			<td>
           				<div>
			               <input type="file" id="input_imgs" name="files" multiple>
			               <input type="button" value="파일삭제" onclick="deleteImgs(this)">
			            </div>
			            <div class="imgs_wrap" name="guestHouseImg">
				           	<span class='thumbnailImgSpan' th:each="img, iterState : ${guestHouseImgs}">
					           	<input type="radio" name="mainImage" th:value="${iterState.index}" th:checked="${img.mainImage}"><img th:src="@{'/gehaImg/'+${img.guestHouseCode}+'/'+${img.savedName}}" data-file="" class="selProductFile" title="Click to remove">
				           	</span>
			            </div>
			            <input type="hidden" name="guestHouse_imglength">
           			</td>
           		</tr>
               <tr>
                  <th><label class="hostPage_label">게스트하우스 이름<br>(상호명)</label></th>
                  <td><input type="text" name="guestHouseName" th:value="${guestHouseDto.guestHouseName}" size="25" style="font-size: 23px;"></td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">태그<br>(복수 선택 가능)</label></th>
                  <td>
                     <label class="checkboxLabel"><input type="checkbox" id="tag" name="gourmet" value="1" th:checked="${guestHouseDto.gourmet}">#맛집</label>
                     <label class="checkboxLabel"><input type="checkbox" id="tag" name="trip" value="1" th:checked="${guestHouseDto.trip}">#관광</label>
                     <label class="checkboxLabel"><input type="checkbox" id="tag" name="shopping" value="1" th:checked="${guestHouseDto.shopping}">#쇼핑</label>
                     <label class="checkboxLabel"><input type="checkbox" id="tag" name="businessTrip" value="1" th:checked="${guestHouseDto.businessTrip}">#출장</label>
                  </td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">설명</label></th>
                  <td>
                  <textarea name="guestHouseInfo" rows="15" cols="63" maxlength="500" onload="load()"></textarea></td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">편의시설</label></th>
                  <td>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="1" th:checked="${#lists.contains(facilities, 1)}">세탁기</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="2" th:checked="${#lists.contains(facilities, 2)}">주차장</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="3" th:checked="${#lists.contains(facilities, 3)}">와이파이</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="4" th:checked="${#lists.contains(facilities, 4)}">에어컨</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="5" th:checked="${#lists.contains(facilities, 5)}">주방/식당</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="6" th:checked="${#lists.contains(facilities, 6)}">엘리베이터</label><br>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="7" th:checked="${#lists.contains(facilities, 7)}">냉장고</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="8" th:checked="${#lists.contains(facilities, 8)}">욕조</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="9" th:checked="${#lists.contains(facilities, 9)}">취사가능</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="10" th:checked="${#lists.contains(facilities, 10)}">전자레인지</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="11" th:checked="${#lists.contains(facilities, 11)}">드라이기</label>
                     <label class="checkboxLabel"><input type="checkbox" name="facilityCode" value="12" th:checked="${#lists.contains(facilities, 12)}">TV</label>
                  </td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">방 등록</label></th>
                  <td id="roomInfoList">
                     <label class="hostPage_label">방 등록하기</label>
                     <input id="addRoomInfoBtn" type="button" value="추가">
                     
                     <div th:each="room, iterState : ${rooms}">
	                     <div class="roomInfoDiv">
	                     	<input type="hidden" name="roomCode" th:value="${room.roomCode}">
				            
				            <table th:name="${room.roomCode}">
				            	<input type="hidden" name="roomIndex" th:value="${iterState.count}">
				               <tr>
				               		<th><label>방 사진 (최대 5장) <p>메인이미지를 선택해주세요.</p></label></th>
				               		<td>
				               			<div>
							               <input type="file" name="roomAttach" onchange="handleImgsFilesSelect(event)" multiple>
							               <input type="button" value="파일삭제" onclick="deleteImgs(this)">
							            </div>
							            <div class="imgs_wrap room_imgs_wrap" name="roomsImg">
							            	<span th:each="img, iterState : ${room.roomImgs}">
								         		<input type="radio" th:name="'mainRoomImage'+${room.roomCode}" th:value="${iterState.index}" th:checked="${img.mainImage}" th:onchange="|javascript:mainImgChange(${room.roomCode}, this.value)|">
								         		<img th:src="@{'/gehaImg/'+${img.guestHouseCode}+'/'+${img.roomCode}+'/'+${img.savedName}}" data-file="" class="selProductFile" title="Click to remove">
							            	</span>
							            </div>
							            <input type="hidden" name="room_imglength">
							            <input type="hidden" name="mainRoomImage" th:id="'mainRoomImage'+${room.roomCode}" th:value="-1">
				               		</td>
				               </tr>
				               <tr>
				                  <th>이름</th>
				                  <td><input type="text" name="roomName" th:value="${room.roomName}"></td>
				               </tr>
				               <tr>
				                  <th>가격</th>
				                  <td><input type="text" class="inputNumber" name="charge" th:value="${#numbers.formatInteger(room.charge, 3, 'COMMA')}" onchange="numberFormat(this)"> 원</td>
				               </tr>
				               <tr>
				                  <th>전용</th>
				                  <td>
				                     <input type="hidden" th:id="'gender'+${room.roomCode}" name="gender" th:value="${room.gender}">
				                     <label><input type="radio" th:name="'gender'+${room.roomCode}" value="N" th:checked="${room.gender}=='N'" onclick="choiceGender(this)">혼성</label>
				                     <label><input type="radio" th:name="'gender'+${room.roomCode}" value="F" th:checked="${room.gender}=='F'" onclick="choiceGender(this)">여성</label>
				                     <label><input type="radio" th:name="'gender'+${room.roomCode}" value="M" th:checked="${room.gender}=='M'" onclick="choiceGender(this)">남성</label>
				                  </td>
				               </tr>
				               <tr>
				                  <th>수용인원 수</th>
				                  <td><input type="text" class="inputNumber" name="capacity" th:value="${room.capacity}" size="5" onchange="numberFormat(this)">명</td>
				               </tr>
				               <tr>
				                  <th>객실 이용안내</th>
				                  <td><textarea name="roomInfo" rows="5" cols="30">asdf</textarea></td>
				               </tr>
				            </table>
				            <input type="button" class="removeRoomBtn" value="삭제" onclick="removeRoom(this)">
				         </div>
				      </div>
                     
                  </td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">숙소 정보</label></th>
                  <td>
                     <label>숙소이용규칙</label><br>
                     <textarea name="rules" rows="20" cols="63" maxlength="1000"></textarea><br><br>
                     <label>주차장 정보</label><br>
                     <textarea name="parkingInfo" rows="10" cols="63" maxlength="100"></textarea>
                  </td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">주소</label></th>
                  <td>
                     <!-- 주소와 우편번호를 입력할 <input>들을 생성하고 적당한 name과 class를 부여한다 -->
					<input type="button" id="postcodify_search_button" value="검색">
					<input type="text" name="address" class="postcodify_address" th:value="${guestHouseDto.address}" size="42"/><br />
                  </td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">오시는 길</label></th>
                  <td><textarea name="directions" rows="10" cols="63" maxlength="100"></textarea></td>
               </tr>
               <tr>
                  <th><label class="hostPage_label">정산계좌 입력</label></th>
                  <td>
                     <label class="bank_label">거래은행</label>
                     <select name="bankName">
                        <option value="국민" th:selected="${guestHouseDto.bankName}=='국민'">국민</option>
                        <option value="농협" th:selected="${guestHouseDto.bankName}=='농협'">농협</option>
                        <option value="기업" th:selected="${guestHouseDto.bankName}=='기업'">기업</option>
                        <option value="우리" th:selected="${guestHouseDto.bankName}=='우리'">우리</option>
                        <option value="신한" th:selected="${guestHouseDto.bankName}=='신한'">신한</option>
                     </select><br>
                     
                     <label class="bank_label">계좌번호</label>
                     <input type="text" name="accountNumber" th:value="${guestHouseDto.accountNumber}">
                  </td>
               </tr>
            </table>
            <br><br>
            <input type="button" value="취소" onclick="history.back()">
            <a th:href="@{deleteGuestHouse(guestHouseCode=${guestHouseCode})}">삭제</a>
            <input id="modifyGuestHouseBtn" type="button" value="수정하기">
         </form>

		 <!-- inputCheck Modal -->
		<div id="inputCheckModal" class="modal">
		
			<!-- Modal content -->
			<div class="modal-content">
				<p id="modalMessage"></p>
				<button id="inputCheckModalClose">확인</button>
			</div>
		</div>

         <div id="defaultRoomInfo" class="roomInfoDiv" style="display: none;">
            <table>
            	<input type="hidden" name="roomIndex">
            	<input type="hidden" name="roomCode" value="0">
            	<tr>
            		<th><label>방 사진 (최대 5장) <p>메인이미지를 선택해주세요.</p></label></th>
            		<td>
			            <div>
			               <input type="file" name="roomAttach" onchange="handleImgsFilesSelect(event)" multiple>
			               <input type="button" value="삭제" onclick="deleteImgs(this)">
			            </div>
			            <div class="imgs_wrap room_imgs_wrap" name="roomsImg"></div>
			            <input type="hidden" name="room_imglength">
			            <input type="hidden" name="mainRoomImage" value="0">
            		</td>
            	</tr>
               <tr>
                  <th>이름</th>
                  <td><input type="text" name="roomName"></td>
               </tr>
               <tr>
                  <th>가격</th>
                  <td><input type="text" class="inputNumber" name="charge" placeholder="0" onchange="numberFormat(this)"> 원</td>
               </tr>
               <tr>
                  <th>전용</th>
                  <td>
                     <input type="hidden" name="gender">
                     <label class="checkboxLabel"><input type="radio" value="N" checked="checked" onclick="choiceGender(this)">혼성</label>
                     <label class="checkboxLabel"><input type="radio" value="F" onclick="choiceGender(this)">여성</label>
                     <label class="checkboxLabel"><input type="radio" value="M" onclick="choiceGender(this)">남성</label>
                  </td>
               </tr>
               <tr>
                  <th>수용인원 수</th>
                  <td><input type="text" class="inputNumber" name="capacity" onchange="numberFormat(this)" size="5"> 명</td>
               </tr>
               <tr>
                  <th>객실 이용안내</th>
                  <td><textarea name="roomInfo" rows="5" cols="30"></textarea></td>
               </tr>
            </table>
            <input type="button" class="removeRoomBtn" value="삭제" onclick="removeRoom(this)">
         </div>
      </div>
      
      <div layout:fragment="hostPage_script">
		<script type="text/javascript" th:inline="javascript">
			window.onload = function () {
			 	$("textarea[name=guestHouseInfo]").val(outputTextArea([[${guestHouseDto.guestHouseInfo}]]));
			 	$("textarea[name=rules]").val(outputTextArea([[${guestHouseDto.rules}]]));
			 	$("textarea[name=parkingInfo]").val(outputTextArea([[${guestHouseDto.parkingInfo}]]));
			 	$("textarea[name=directions]").val(outputTextArea([[${guestHouseDto.directions}]]));
			 	
			 	for(var i=0; i<[[${#lists.size(rooms)}]]; i++) {
			 		$('table[name=' + [[${rooms}]][i].roomCode + ']').find('textarea[name=roomInfo]').val(outputTextArea([[${rooms}]][i].roomInfo));
			 	}
			}
		
            var roomIndex=[[${#lists.size(rooms)}]]+1;
            $("#addRoomInfoBtn").click(function() {
            	var div = document.createElement('div');
                div.setAttribute('class', 'roomInfoDiv');
                
                document.getElementById('roomInfoList').appendChild(div);
                
                var cloneRoom = $('#defaultRoomInfo').children().clone();
                cloneRoom.find('input[name=roomIndex]').val(roomIndex);
                cloneRoom.find('input[type=radio]').attr('name', 'gender'+roomIndex);
                cloneRoom.find('input[name=gender]').attr('id', 'gender'+roomIndex);
                cloneRoom.find('input[name=gender]').val('N');
                cloneRoom.appendTo(div);
                roomIndex++;
            })
            
            function removeRoom(removeRoomBtn) {
            	$(removeRoomBtn).parent().remove();
            }
            
            function choiceGender(obj) {
               var genderName = obj.name;
               $('#'+genderName).val(obj.value);
            }
            
            //게스트하우스 수정하기
            $("#modifyGuestHouseBtn").click(function() {
           		if(checkValue()) {
           			console.log("true");
           			inputTextArea();
	               $("#modifyGuestHouseForm").submit();
	           	} else {
	           		console.log("false");
	           	}
            })
            
            
             
           	function checkValue() {
            	console.log("checkValue");
            	
            	if(!($("input:checkbox[id='tag']").is(":checked")) || !($("input:checkbox[name='facilityCode']").is(":checked"))) { //체크란 체크여부
            		$("#modalMessage").text("체크란을 체크해주세요!");
            		$("#inputCheckModal").css("display", "block");
            		return false;
            	} else if($(".guestHouse_table").find('.roomInfoDiv').length == 0) { //방 등록 여부
            		$("#modalMessage").text("방 등록은 1개 이상이어야합니다.");
            		$("#inputCheckModal").css("display", "block");
            		return false;
            	}
            	console.log("1");
            	//파일 업로드 여부
            	var imgDivTags = $(".guestHouse_table").find(".imgs_wrap");
            	for(var i=0; i<imgDivTags.length; i++) { 
            		if($(imgDivTags[i]).children().length==0) {
            			$("#modalMessage").text("파일 업로드를 해주세요!");
                		$("#inputCheckModal").css("display", "block");
                		return false;
            		}
            	}
            	console.log("2");
            	//textarea 태그 개수
            	var textareaTags =  $(".guestHouse_table").find("textarea");
            	for(var i=0; i<textareaTags.length; i++) {
            		if(!textareaTags[i].value) {
            			$("#modalMessage").text("입력란을 모두 작성해주세요!");
                		$("#inputCheckModal").css("display", "block");
                		return false;
            		}
            	}
            	console.log("3");
            	var inputTextTag = $(".guestHouse_table").find("input[type=text]");
            	for(var i=0; i<inputTextTag.length; i++) {
            		if(!inputTextTag[i].value) {
            			$("#modalMessage").text("입력란을 모두 작성해주세요!");
                		$("#inputCheckModal").css("display", "block");
                		return false;
            		}
            	}
            	
            	console.log("4");
            	//숫자 받는 입력란 콤마 제거
            	var inputNumberTag = $(".guestHouse_table").find(".inputNumber");
            	for(var i=0; i<inputNumberTag.length; i++) {
            		var x = inputNumberTag[i].value;
            		inputNumberTag[i].value = removeCommas(x);
            	}
            	console.log("5");
            	return true;
            }
            
            function numberFormat(obj) {
            	$(obj).val(addCommas($(obj).val().replace(/[^0-9]/g,"")));
            }
            
           //3자리 단위마다 콤마 생성
            function addCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
             
            //모든 콤마 제거
            function removeCommas(x) {
                if(!x || x.length == 0) return "";
                else return x.split(",").join("");
            }
            
            //textArea br태그 넣기
            function inputTextArea() {
            	var textareaTags =  $(".guestHouse_table").find("textarea");
            	for(var i=0; i<textareaTags.length; i++) {
            		var str = textareaTags[i].value;
        			str = str.replace(/(?:\r\n|\r|\n)/g, '<br/>');
        			textareaTags[i].value=str;
            	}
            }
            
            function outputTextArea(value) {
            	var str = value;
            	str = str.split('<br/>').join("\r\n");
            	return str;
            }
            

            $("#inputCheckModalClose").click(function() {
            	$("#inputCheckModal").css("display", "none");
            })
            
            //파일업로드
            var sel_files = [];
            
            $(document).ready(function() {
               $('#input_imgs').on("change", handleImgsFilesSelect);
            });
            
            function handleImgsFilesSelect(e) {
               //이미지 정보들을 초기화
               sel_files = [];
               var prtDiv = e.target.parentNode.nextElementSibling; // div imgs_wrap
               var roomInfoTable = $(prtDiv).parent().find('table');
               
               $(prtDiv).empty();
               
               var files = e.target.files;
               var filesArr = Array.prototype.slice.call(files);
               
               
               if(e.target.name == "roomAttach") {
            	   if(2 > files.length || files.length > 5) {
            		   alert("방 이미지는 2장~5장까지만 등록하실 수 있습니다.");
                       $(e.target).val("");
            		   return;
            	   }
               } else {
            	   if(4 > files.length || files.length > 10) {
            		   alert("게스트하우스 이미지는 4장~10장까지만 등록하실 수 있습니다.");
            		   $(e.target).val("");
            		   return;
            	   }
               }
               
               var index = 0;
               filesArr.forEach(function(f) {
                  if(!f.type.match("image.*")) {
                     alert("확장자는 이미지 확장자만 가능합니다.");
                     return;
                  }
                  
                  sel_files.push(f);
                  
                  var reader = new FileReader();
                  reader.onload = function(e) {
                     
                     if($(prtDiv).attr("name")=='roomsImg') { //방일 경우
                        var html = 
                           "<span class='thumbnailImgSpan'><input type='radio' name='mainRoomImage"+$(roomInfoTable).find("input[name='roomIndex']").val()+"' value='"+index
                           +"' onclick='clickMainRoomImg($(this).parent().parent().next().next(), this.value)'"+(index==0?'checked=checked':'')+"><img src=\""+e.target.result+"\" data-file='"+f.name
                           +"' class='selProductFile' title='Click to remove'></span>";
                     } else { //게스트하우스일 경우
                        var html = "<span class='thumbnailImgSpan'><input type='radio' name='mainImage' value='"+index+"' "+(index==0?'checked=checked':'')+"><img src=\""+e.target.result+"\" data-file='"+f.name
                        +"' class='selProductFile' title='Click to remove'></span>";
                     }
                     $(prtDiv).append(html);
                     index++;
                     $(prtDiv).next('input[type=hidden]').val(index);
                  }
                  reader.readAsDataURL(f);
               });
            }
/*             
            $("#deleteImgsBtn").click(function() {
               $("#input_imgs").val("");
               $(".selProductFile").remove();
            }) */
            
            function deleteImgs(obj) {
                var input_imgs = obj.previousElementSibling;
               $(input_imgs).val("");
               var brtDiv = obj.parentNode.nextElementSibling;
               $(brtDiv).children().remove();
            }
            
            function clickMainRoomImg(obj, chkValue) {
               $(obj).val(chkValue);
            }
            
            function mainImgChange(roomCode, value) {
            	$('#mainRoomImage'+roomCode).val(value);
            }
            
         </script>
         
         <!-- Postcodify를 로딩한다 -->
		 <script src="//d1p7wdleee1q2z.cloudfront.net/post/search.min.js"></script>
		
		 <!-- "검색" 단추를 누르면 팝업 레이어가 열리도록 설정한다 -->
		 <script> $(function() { $("#postcodify_search_button").postcodifyPopUp(); }); </script>
      </div>
   </body>
</html>