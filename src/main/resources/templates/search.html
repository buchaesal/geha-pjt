<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="fragments/main_layout">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Mapapi Test</title>

<!-- jquery ui-->
<link rel="stylesheet" href="/css/jquery-ui.min.css" />

<!-- datepicker (min쓰면 안됨) -->
<link rel="stylesheet" href="/css/datepicker.css" />

<style>
	@font-face { 
		font-family: 'S-CoreDream-3Light';
		src: url('fonts/SCDream3.otf') format('opentype');
		font-weight: normal;
		font-style: normal;
	}
	
	/* a tag reset */
	a:link, a:visited, a:active, a:hover {
		color: #000;
		text-decoration: none;
	}
	
	hr {
		visibility:hidden;
	}
	
	

	
	.container{
		margin-top: 3rem;
	}
	
 	.searcharea{ 
  		border: 1px solid rgba(30,30,30,0.2);
  		border-radius: 0.5rem;
   		height: 100%;
   		margin-bottom:3rem;
 	}
 	
 	.form-control[readonly]{
 		background-color: #fff;
 	}
 	
 	#date {
		cursor: pointer;
	}	
	
 	input[type="text"]{ 
  		width:90%;
   		margin: 0 auto;
 	}

 	button.resetStyle {
 		position: static;
		border: 0;
	    top: 25px;
	    right: 0;
	    width: 24px;
	    height: 24px;
	    text-indent: -9999px;
 	}
	button#down{
		background: url(img/button/ico_minus.png) 50% 50% no-repeat;
	    background-size: 20px auto;
	}
	button#up{
		background: url(img/button/ico_plus.png) 50% 50% no-repeat;
	    background-size: 20px auto;
	}
	button:disabled{
		opacity: 0.2;
	}
 	 
 	.maparea{ 
 		margin-bottom:3rem;	
 	}
 	
 	#map{
 		background-color:gray;
 		height:450px;
 	}
 	
 	.house {
 		margin: 1rem 0;
 	}
	
	.housewrapper{
		margin-top: 1rem;
	}
	
	.houseborder{
		border:2px solid #FFB0AE;
	}
	
	#searchresult{
		min-height:300px;
	}
	
	.houseimage{
		width:100%;
		height:200px;
		background-color: gray;
		background-size:cover;
	}
	
	.contentwrapper{
		padding:0rem 2rem;
		font-family: 'S-CoreDream-3Light';
	}
	
  	.content.gehaname{
		padding-top:0.7rem;
		height:6rem;
		text-align:left;
        word-break: keep-all;
        word-wrap: break-word;
	}
	.content span.gehaname{
		vertical-align: center;
	}
	.content.yellowline{
		color:rgba(255,167,38,1);
	}
	.content span.rating{
		background-color:rgba(255,167,38,1);
		color:#FFF;
		border-radius:0.3rem;
		padding: 0 0.3rem;
	}
	.content.tag{
		margin-top:1rem;
		height:3rem;
	}
	.content span.tag{
		display:inline-block;
		background-color:gray;
		border-radius:0.3rem;
		color:#FFF;
		margin-top:0.2rem;
		padding: 0.2rem 0.2rem;
	}
	.content.price{
		text-align:right;
		margin-top: 1rem;
		margin-bottom:1rem;
	}
</style>
</head>
<body>

<div layout:fragment="content">
	<div class="container">
		<div class="row">
			<div class="col-md-3 col-sm-4 searcharea">
				<form role="form" action="#">
					<div class="form-group" style="margin-top:20px">
						<label for="date">날짜</label>
						<input id="date" type="text" data-range="true" data-multiple-dates-separator=" ~ " data-language="en" class="datepicker-here form-control"/>
						<input type="hidden" id="startdate" name="bookingStart" />
						<input type="hidden" id="enddate" name="bookingEnd" />
					</div>
					
					<hr />
					
					<div class="form-group">
						<label for="keywordsearch">키워드 검색</label>
						<input type="text" id="keywordsearch" name="keyword" class="form-control"/>				
					</div>
					
					<hr />
					
					<div class="form-group">
						<div class="col-xs-6" style="padding-left:0px;padding-right:0px"><strong>인원</strong></div>
						<div class="col-xs-6" style="padding-left:0px;padding-right:0px">
							<button type="button" id="down" class="resetStyle" disabled>-</button>
							<span id="person">1</span>
							<input type="hidden" name="bookingNumber" class="person" value="1" />
							<button type="button" id="up" class="resetStyle">+</button>
						</div>
					</div>
					
					<hr />
					
					<div class="form-group">
						<strong>가격</strong>
						<small>(1인 1박 기준)</small>
						<span id="amount" style="color:#f6931f; font-weight:bold;"></span><br /><br />
						<div id="slider-range" class="slider_align ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content"></div>
						<input type="hidden" id="minprice" name="minprice" />
						<input type="hidden" id="maxprice" name="maxprice" />				
					</div>
					
					<div class="checkbox">
						<p><strong>성별</strong></p>
						<label class="col-xs-6">
							<input type="checkbox" name="gender" value="f" />여성전용
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="gender" value="m" />남성전용
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="gender" value="n" />남녀공용				
						</label>
					</div>
					
					<br />
					<br />
					
					<div class="checkbox">
						<p><strong>테마</strong></p>
						<label class="col-xs-6">
							<input type="checkbox" name="trip" value="1" />#관광
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="gourmet" value="1" />#맛집
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="shopping" value="1" />#쇼핑
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="businessTrip" value="1" />#출장				
						</label>
					</div>
					
					<br />
					<br />
					
					<div class="checkbox">
						<p><strong>편의시설</strong></p>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="1"/>세탁기
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="2"/>주차장
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="3"/>주방/식당
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="4"/>엘리베이터
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="5"/>취사가능
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="6"/>전자레인지
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="7"/>와이파이
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="8"/>에어컨
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="9"/>냉장고
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="10"/>욕조
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="11"/>드라이기
						</label>
						<label class="col-xs-6">
							<input type="checkbox" name="facilities" value="12"/>TV
						</label>
					</div>
					
					<button id="btn-search" type="button" class="btn btn-default btn-block btn-danger" style="margin-top:180px;margin-bottom:30px;">검색</button>
				</form>
			</div>
			
			<div class="col-md-9 col-sm-8 maparea">
			
				<div id="map"></div>

				<hr />

				<div id="searchresult"> <!-- handlebars template target -->
					
				</div> <!-- searchresult end -->
				
			</div> <!-- end maparea -->
		</div> <!-- end row -->
	</div> <!-- end container -->
</div> <!-- end layout content -->

<div layout:fragment="script">
<!-- script start -->
	<!-- jquery/ui -->
	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="vendor/jquery/jquery-ui.min.js"></script>
	<script src="js/jquery.serializeObject.min.js"></script>
	
	<!-- handlebars -->
	<script src="js/handlebars4.js"></script>
	
	<!-- datepicker -->
	<script src="js/datepicker.js"></script>
	<script src="js/i18n/datepicker.en.js"></script>
	
	<!-- bootstrap -->
	<script src="js/bootstrap.min.js"></script>
	
	<!-- daum map -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e82dcfc69e95758ed76053beed11845a&libraries=services,clusterer"></script>
	
	<script>
	$(function(){
		/* 오늘날짜부터 선택가능 / input hidden으로 나누어서 저장 / 세미콜론(;)넣지 않음 주의 */
	  	$(".datepicker-here").datepicker({
			language: 'en',
			minDate: new Date(),
			range: true,
			autoClose: true,
		    onSelect: function onSelect(fd, date){
		    	$("#startdate").val(fd.split(" ~ ")[0])
		    	$("#enddate").val(fd.split(" ~ ")[1])
		    }
		});
		
	  	/* slider-range */
	  	$("#slider-range").slider({
		      range: true,
		      min: 10000,
		      max: 300000,
		      step: 10000,
		      values: [ 10000, 300000 ],
		      slide: function( event, ui ) {
		        $("#amount").text( Math.floor(ui.values[0]/10000) + "만원 ~ " + Math.floor(ui.values[1]/10000) + "만원");
		        $("#minprice").val(ui.values[0]);
		        $("#maxprice").val(ui.values[1]);
		      }
		});
	  	
   		$("#amount").text( $( "#slider-range" ).slider( "values", 0 )/10000 + "만원" +
	    	  		" ~ " + $( "#slider-range" ).slider( "values", 1 )/10000 + "만원" );
	   	$("#minprice").val($( "#slider-range" ).slider( "values", 0 ));
   		$("#maxprice").val($( "#slider-range" ).slider( "values", 1 ));
	   
	   /* 인원수 버튼 구현 */
	   var personCnt = 1;
	   var spanPerson = $("span#person");
	   var inputPerson = $("input.person");
	   var buttonUp = $("button#up");
	   var buttonDown = $("button#down");
	   
	   buttonUp.click(function(){
		   plusCnt();
		   validCnt();
		   spanPerson.html(personCnt);
		   inputPerson.val(personCnt);
	   });
	   
	   buttonDown.click(function(){
		   minusCnt();
		   validCnt();
		   spanPerson.html(personCnt);
		   inputPerson.val(personCnt);
	   });
	   
	   function plusCnt(){
		   personCnt++;
	   }
	   function minusCnt(){
		   personCnt--;
	   }
	   function validCnt(){
		   if (personCnt >= 10){
			   personCnt = 10;
			   buttonUp.attr("disabled", true);
		   } else {
			   buttonUp.attr("disabled", false);
		   }
		   
		   if (personCnt <= 1){
			   personCnt = 1;
			   buttonDown.attr("disabled", true);
		   } else {
			   buttonDown.attr("disabled", false);
		   }
	   }
	});
	</script>
	<script id="template" type="text/x-handlebars-template">
		{{#each .}}
			<div class="housewrapper col-lg-4 col-md-6 col-xs-12">
				<a href="roomInfo?guestHouseCode={{guestHouseCode}}">
					<div class="houseborder">
						<div class="houseimage" style="background-image:url({{originalName}});">
						</div>
						<div class="contentwrapper">
							<div class="content gehaname">
								<h4><span class="gehaname">{{guestHouseName}}</span></h4>
							</div>
							<div class="content yellowline">
								<span class="rating">{{avgRating}}</span>
								<span class="ratingname">{{recommendRating}}</span>
								<span class="comments">({{reviewCnt}})</span>
							</div>
							<div class="content tag">
								{{#ifOne trip}}
									<span class="tag">#관광</span>
								{{/ifOne}}
								{{#ifOne gourmet}}
									<span class="tag">#맛집</span>
								{{/ifOne}}
								{{#ifOne shopping}}
									<span class="tag">#쇼핑</span>
								{{/ifOne}}
								{{#ifOne businesstrip}}
									<span class="tag">#출장</span>
								{{/ifOne}}
							</div>
							<div class="content price">
								<span class="price">{{minprice}}원</span>
							</div>
						</div>
					</div>
				</a>
			</div> <!-- housewrapper end -->
		{{/each}}
	</script>
	<script> /* handlebars and daum maps api */
	$(function(){
		
 		var gehaArr = [];
		var gehaObj = {};
		
 		$("#btn-search").click(function(){
			var formData = $("form").serializeObject();
			delete formData["_csrf"];
			console.log(formData);
			
			console.log(JSON.stringify(formData));
			
			var getData = $.ajax({
			  url: "searchgehainfo",
			  type: "GET",
			  contentType: "application/json; charset=utf8",
			  data: formData,
			  dataType: "json"
			})
			.done(function(data){
				var source = $("#template").html();
				var template = Handlebars.compile(source);
				$("#searchresult").html(template(data));
			})
			.fail(function(){
				alert("failed");
			});
		});
		
		/* promise로 비동기 콜백함수 문제 해결 --지도 다중 마커-- */
/* 		function getData() {
		  return new Promise(function (resolve, reject) {
		    $.get('searchgehainfo', function (response) {
		      if (response) {
		        resolve(response);
		      }
		      reject(new Error("Request is failed"));
		    });
		  });
		} */
		
		/* var getData = $.ajax({
		  url: "searchgehainfo",
		  type: "get", //send it through get method
		  data: { 
		    ajaxid: 4, 
		    UserID: UserID, 
		    EmailAddress: EmailAddress
		  },
		})
		.done(function(){
			
		})
		.done(function(){
			
		})
		.fail(function(){
			
		}); */
		

/* 		getData()
			.then(function (data) {
				var source = $("#template").html();
				var template = Handlebars.compile(source);
				$("#searchresult").html(template(data));
				
				for(var i=0, len=data.length; i<len; i++){
					gehaObj = {
						ghname : data[i].guestHouseName,
						ghaddress : data[i].address
					}
					gehaArr.push(gehaObj);
				}
				console.log(gehaArr);
			})
			.then(function() {
				var geocoder = new daum.maps.services.Geocoder();

				console.log("gehaArr", gehaArr);
				
				console.log(gehaArr[0]);
				
				for (var i=0; i < gehaArr.length ; i++) {
					
					console.log("gehaArr[i]-1", gehaArr[i]);
					
					geocoder.addressSearch(gehaArr[i].ghaddress, function(result, status) {
					     if (status === daum.maps.services.Status.OK) {
					    	console.log("this", this);

					    	var coords = new daum.maps.LatLng(result[0].y, result[0].x);	
					        var marker = new daum.maps.Marker({
					            map: map,
					            position: coords
					        });
					    }
					});
				}
			})
			.catch(function (err) {
			  console.error(err); // Error 출력
			}); */
		
		/* handlebars ifOne helper for tags */
		Handlebars.registerHelper('ifOne', function(a, opts) {
		    if(a == 1)
		        return opts.fn(this);
		    else
		        return opts.inverse(this);
		});
		
		/* daum map */
		var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
	    mapOption = { 
	        center: new daum.maps.LatLng(37.54477858829654, 127.00561259855127), // 지도의 중심좌표
	        level: 8 // 지도의 확대 레벨
	    };
		var map = new daum.maps.Map(mapContainer, mapOption);
		// 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
		var zoomControl = new daum.maps.ZoomControl();
		map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);
		
		function setZoomable(zoomable){
			map.setZoomable(zoomable);
		}
		
		/* map을 클릭하면 휠로 줌 가능 */
		daum.maps.event.addListener(map, 'click', function(){
			console.log("map clicked");
			setZoomable(true);
		});
		/* map을 드래그하기 시작하면 휠로 줌 가능*/
		daum.maps.event.addListener(map, 'dragstart', function(){
			console.log("map dragstarted");
			setZoomable(true);
			getInfo();
		});
		
		/* default */
		setZoomable(false);
		
		/* mouse가 map을 벗어나면 휠로 줌 불가능 */
		daum.maps.event.addListener(map, 'mouseout', function(){
			console.log("map mouseouted");
			setZoomable(false);
		});
		
		/* xxx */
		function getInfo() {
		    // 지도의 현재 중심좌표를 얻어옵니다 
		    var center = map.getCenter(); 
		    
		    // 지도의 현재 레벨을 얻어옵니다
		    var level = map.getLevel();
		    
		    // 지도의 현재 영역을 얻어옵니다 
		    var bounds = map.getBounds();
		    
		    // 영역의 남서쪽 좌표를 얻어옵니다 
		    var swLatLng = bounds.getSouthWest(); 
		    
		    // 영역의 북동쪽 좌표를 얻어옵니다 
		    var neLatLng = bounds.getNorthEast(); 

		    var message = '지도 중심좌표는 위도 ' + center.getLat() + ', <br>';
		    message += '경도 ' + center.getLng() + ' 이고 <br>';
		    message += '지도 레벨은 ' + level + ' 입니다 <br> <br>';
		    message += '지도의 남서쪽 좌표는 ' + swLatLng.getLat() + ', ' + swLatLng.getLng() + ' 이고 <br>';
		    message += '북동쪽 좌표는 ' + neLatLng.getLat() + ', ' + neLatLng.getLng() + ' 입니다';
		    
		    console.log(message);
		}
		/* xxx */
		
	}); /* document onload function end */
</script>
<script>
$(function(){
	/* 검색 기본 날짜 설정 */
	var getToday = new Date();
	var getTomorrow = new Date();
	getTomorrow.setDate(getTomorrow.getDate() + 1);
	
	var strToday = getToday.getFullYear() + '-' + lessThanTen(getToday.getMonth() + 1) + '-' + lessThanTen(getToday.getDate());
	var strTomorrow = getTomorrow.getFullYear() + '-' + lessThanTen(getTomorrow.getMonth() + 1) + '-' + lessThanTen(getTomorrow.getDate());
	
	$('#date').val(strToday + ' ~ ' + strTomorrow);
	$('#startdate').val(strToday);
	$('#enddate').val(strTomorrow);
	
	function lessThanTen(d){
		if (d < 10){
			return '0'+d;
		} else {
			return d;
		}
	}
});
</script>
<!-- script end -->
</div> <!-- end layout script -->

</body>
</html>